<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Facebook Messenger - API</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
</head>
<body>

<script>
   window.fbAsyncInit = function() {
      FB.init({
         appId      : '1202074766852669',
         cookie     : true,
         xfbml      : true,
         version    : 'v8.0'
      });

      FB.AppEvents.logPageView();

   };

   (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = "https://connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

<div id="fb-root"></div>

<!--INBOX-->
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/es_LA/sdk.js#xfbml=1&version=v8.0&appId=1202074766852669&autoLogAppEvents=1" nonce="JwplBKEA"></script>

<div id="app">

    <div>
        <p>* Status: {{status_connected}}</p>
    </div>

    <p><hr></p>

    <!--Fuera de Sesión-->
    <template v-if="!loggedIn">
        <p>
            <span>* Facebook Messenger: <b>Fuera de sesión...</b></span>
        </p>

        <button @click="alertLoginFacebook" class="loginBtn loginBtn--facebook">
            Login with Facebook
        </button>
    </template>


    <!--En Sesión-->
    <template v-if="loggedIn">
        <p>
            <span>* Página de Facebook Messenger: <b>En sesión...</b></span>
        </p>

        <button type="button" @click="logout()" :disabled="button.logout.disabled">Cerrar Sesion</button> <span>{{button.logout.status}}</span>

        <p><hr></p>

        <template v-if="loggedIn">
            <p>
                <span>* Tipo Mensaje:</span>
            </p>
            <!--<p>-->
                <!--<input type="text" v-model="message.phone" placeholder="Phone">-->
            <!--</p>-->
            <p>
                <label>
                    <input type="radio" name="rd"
                           v-model="files.radio.status" value="1" @change="typeMessage(1)" :disabled="files.pdf.status || files.audio.status">
                    Texto
                </label>
                <label>
                    <input type="radio" name="rd"
                           v-model="files.radio.status" value="2" @change="typeMessage(2)" :disabled="files.pdf.status || files.audio.status">
                    Imagen
                </label>
                <label>
                    <input type="radio" name="rd"
                           v-model="files.radio.status" value="3" @change="typeMessage(3)" :disabled="files.image.status || files.audio.status">
                    Doc pdf
                </label>
                <label>
                    <input type="radio" name="rd"
                           v-model="files.radio.status" value="4" @change="typeMessage(4)" :disabled="files.image.status || files.pdf.status">
                    Archivo audio
                </label>
                <label>
                    <input type="radio" name="rd"
                           v-model="files.radio.status" value="5" @change="typeMessage(5)" :disabled="files.image.status || files.pdf.status">
                    Archivo video
                </label>
                <label>
                    <input type="radio" name="rd"
                           v-model="files.radio.status" value="6" @change="typeMessage(6)" :disabled="files.image.status || files.pdf.status">
                    Template
                </label>
            </p>

            <p v-if="files.image.status || files.pdf.status">
                <input type="text" v-model="message.filename" placeholder="Filename">
                <input type="text" v-model="message.caption" placeholder="Caption">
            </p>

            <p>
                <span>* Mensaje:</span>
            </p>
            <p>
                <textarea name="" id="" cols="100" rows="5" v-model="message.body" placeholder="Body"></textarea>
            </p>

            <button type="button" @click="sendMessage()" :disabled="button.message.disabled">Enviar mensaje</button> <span>{{button.message.status}}</span>

            <p><hr></p>

        </template>

    </template>

</div>

<script>

  //Webhook = https://devinbox.securitec.pe:446/mywebhook/chat_api
  const FB_URL = "https://graph.facebook.com/v8.0/me/messages"
  const PAGE_ACCESS_TOKEN = "EAARFR9d4wj0BAAR3RDmBw17BOXCNOWJFxZC1kwPLATZCLARgxca3FNyOZAvwZADiKeySN95g5uEbIfwZCiBEvnt6AdEKZAy3ts5CQcvJzBeiul8lZBkTlPOrA8ZBGFHp5HpP4yOC73dHxH7ifoCAqenjKQ9wyoI9voE0k86NbBKZARwZDZD"

  // const API_URL = "https://devinbox.securitec.pe:446"
  // const CHATAPI_URL = "https://eu159.chat-api.com/instance155047"//Cuenta de securitec de gabriela
  // const CHATAPI_TOKEN = "ol1liyjmehf87oh7"
  // const INSTANCE = "155047"

  new Vue({
    el: '#app',
    data: ()=>({
      loggedIn: false,
      status_connected: 'Disconnected',


      qr : {
        loading: false,
        used: false,
        image: null
      },
      input: {
        message: null,
      },
      message:{
        uri: "/sendMessage",
        phone: '51955588297',
        body: null,
        status: null,
        filename: null,
        caption: null
      },
      files: {
        radio:{
          status: 1,
        },


        text:{
          status: false
        },
        image: {
          status: false,
          url: 'https://i2.wp.com/velozityweb.com/blog/wp-content/uploads/2019/02/bootstrap-4-logo.jpg',
        },
        pdf: {
          status: false,
          url: 'http://www.wiener.edu.pe/manuales/4to-ciclo/programacion-web-2/curso-practico-de-javascript.pdf',
        },
        audio: {
          status: false,
          url: 'https://upload.wikimedia.org/wikipedia/commons/2/24/Sahan_Test_Audio.ogg',
        },
        video: {
          status: false,
          url: 'https://upload.wikimedia.org/wikipedia/commons/2/24/Sahan_Test_Audio.ogg',
        },
      },
      button: {
        qr:{
          disabled: false,
          status: null
        },
        message: {
          disabled: false,
          status: null
        },
        logout: {
          disabled: false,
          status: null,
        },
      },
      exit: false,
      queues:{
        total: 0,
        data: []
      }
    }),
    mounted(){
      axios.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest'
    },
    async created(){
      // await this.load()
      // this.qr.used = true
      // await this.startInterval()
      // setInterval(()=>{
      //   this.getQueues()
      // },3500)
    },
    methods: {
      //Iniciar sesion en facebook y vinvular pagina
      alertLoginFacebook(){

        if (confirm('Paso #1. Iniciar sesion como [Usuario en Facebook]')) {
          // Save it!
          console.log('Thing was saved to the database.');

          if (confirm('Paso #2. Seleccione la página de facebook que desea asociar a Inbox')) {
            // Save it!
            console.log('Thing was saved to the database.');

            if (confirm('Paso #3. Inbox necesita los siguientes permisos para continuar...')) {
              // Save it!
              console.log('Thing was saved to the database.');

              alert("Su página de facebook ha sido vinculada con exito!")

              this.button.logout.disabled = false
              this.button.logout.status = null
              this.loggedIn = true
              this.status_connected = "Connected"

            } else {
              this.loggedIn = false
              // Do nothing!
              console.log('Thing was not saved to the database.');
            }

          } else {
            this.loggedIn = false
            // Do nothing!
            console.log('Thing was not saved to the database.');
          }

        } else {
          this.loggedIn = false
          // Do nothing!
          console.log('Thing was not saved to the database.');
        }

      },
      //Enviar mensaje
      typeMessage(type){
        this.message.body = null
        this.message.uri = "/messages"
        switch(type){
          case 1:
            if(this.files.image.status) {
              this.message.uri = "/sendFile"
              this.message.body = this.files.image.url
            }
            break
          case 2:
            if(this.files.pdf.status){
              this.message.uri = "/sendFile"
              this.message.body = this.files.pdf.url
            }
            break
          case 3:
            if(this.files.audio.status){
              this.message.uri = "/sendPTT"
              this.message.body = this.files.audio.url
            }
            break
        }
      },
      async sendMessage() {

        this.button.message.disabled = true
        this.button.message.status = 'enviando...'

        const url = `${FB_URL}?access_token=${PAGE_ACCESS_TOKEN}`
        const headers = {headers: {'Content-Type': 'application/json'}}

        const params = {
          recipient: {
            id: '2062318657226508'
          },
          message:{}
        }

        //Preparar mensaje
        //Texto
        if(this.files.radio.status == 1){
          params.message.text = this.message.body
        }
        //Imagen
        if(this.files.radio.status == 2){
          params.message = {
            attachment: {
              type: 'image',
              payload: {
                url: 'https://www.eniun.com/wp-content/uploads/Bootstrap-descargar-instalar.png',
                is_reusable: false,
              },
            },
          }
        }
        //PDF
        if(this.files.radio.status == 3){
          params.message = {
            attachment: {
              type: 'file',
              payload: {
                url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
                is_reusable: false,
              },
            },
          }
        }
        //Audio
        if(this.files.radio.status == 4){
          params.message = {
            attachment: {
              type: 'audio',
              payload: {
                url: 'https://www.elongsound.com/images/mp3/pasada_de_un_avion_8.mp3',
                is_reusable: false,
              },
            },
          }
        }
        //Video
        if(this.files.radio.status == 5){
          params.message = {
            attachment: {
              type: 'video',
              payload: {
                // url: 'http://techslides.com/demos/sample-videos/small.webm',
                url: 'http://clips.vorwaerts-gmbh.de/VfE_html5.mp4',
                is_reusable: false,
              },
            },
          }
        }
        //Template
        if(this.files.radio.status == 6){
          params.message = {
            attachment: {
              type: 'template',
              payload: {
                 template_type: 'generic',
                 elements:[
                    {
                       title:'Inbox',
                       image_url:'https://www.eniun.com/wp-content/uploads/Bootstrap-descargar-instalar.png',
                       subtitle:'Inbox powered by Securitec',
                       default_action:{
                          type:'web_url',
                          url:'https://inbox.securitec.pe',
                       },
                       buttons:[
                          {
                             type:'web_url',
                             url:'https://inbox.securitec.pe',
                             title:'pay inbox #1',
                          },
                          {
                             type:'web_url',
                             url:'https://inbox.securitec.pe',
                             title:'pay inbox #2',
                          },
                       ],
                    },
                 ],
              },
            },
          }
        }

        await axios.post(url, params, headers).then((r) => {
          console.log(r.data)
          if(r.status === 200){

            if(r.data.recipient_id)
               this.button.message.status = 'mensaje enviado'
            else
               this.button.message.status = 'no enviado'

            this.button.message.disabled = false

          }
        }).catch((e) => {

          console.error(e)
          this.button.message.disabled = false
          this.button.message.status = 'no enviado'

        })
      },
      //Cerrar sesionm
       async logout(){

          this.button.logout.disabled = true
          this.button.logout.status = 'cerrando sesion...'

          setTimeout(() => {
             this.loggedIn = false
             this.status_connected = "Disconnected"
          }, 1500)
       },
       //Paginas de facebook
       async pages(){
          const url = "https://graph.facebook.com/v2.6/1202074766852669/ids_for_pages/"
          const params = {
             // page: '',
             access_token: '',
             appsecret_proof: '',
          }

          await axios.get(url, {params: params}).then((r)=>{
             console.log(r)
          }).catch((e) => {
             console.error(e)
          })
       },

      /*
      // Start Interval
      async getWebhookTmp(){
        const url = `${API_URL}/mywebhook/chat_api/data`
        await axios.get(url).then(async (r)=>{

          console.log(r)
          console.log(r.data)

          if(r.data) {
            //Validar instancia
            if (r.data.instanceId === INSTANCE) {

              //Validar estado
              if (r.data.status === 'got qr code') {

                if (r.data.substatus === 'expired') {
                  this.button.qr.disabled = false
                  this.button.qr.status = null
                  this.qr.image = null
                }

                if (r.data.previous_status === "got qr code") {
                  this.qr.loading = false
                  this.qr.used = false
                  this.exit = false
                }

                if (r.data.previous_status === "loading") {
                  this.qr.loading = false
                  this.qr.used = false
                  this.exit = false
                }

              }
              else if (r.data.status === 'loading') {

                if (r.data.previous_status === "authenticated") {
                  this.button.qr.disabled = false
                  this.qr.used = false
                  this.button.qr.status = null
                  this.qr.loading = false
                  this.qr.image = null
                  this.exit = true
                }

                if (r.data.previous_status === "got qr code") {
                  this.qr.loading = true
                  this.qr.used = false
                  this.exit = false
                }

              }
              else if (r.data.status === 'authenticated') {

                if (r.data.previous_status === "authenticated") {
                  if(r.data.substatus === 'normal'){
                    this.button.logout.disabled = true
                    this.button.message.disabled = true
                    this.button.qr.disabled = false
                    this.qr.image = null
                    this.qr.used = true
                    this.exit = true
                  }
                }

                if (r.data.previous_status === "loading") {
                  this.button.logout.disabled = false
                  this.button.message.disabled = false
                  this.button.qr.disabled = true
                  this.qr.image = null
                  this.qr.used = true
                  this.exit = false
                }

              }

            }
          }

        }).catch((e)=>{
          console.error("getWebhook",e)
        })
      },
      async startInterval(){
        setInterval(async ()=>{
          await this.getWebhookTmp()
        }, 999)
      },
      // End Interval
      async load() {
        await this.getStatusConnection()
      },
      async getStatusConnection () {
        this.status_connected = 'Connecting...'
        const url = `${API_URL}/connect`
        await axios.get(url).then((r) => {
          setTimeout(() => {
            this.status_connected = r.data
          }, 1500)
        }).catch((e) => {
          this.status_connected = 'Disconnected'
          console.error(e)
        })
      },
      async getCodeQR () {

        this.button.qr.disabled = true
        this.button.qr.status = 'obteniendo QR...'

        const url = `${CHATAPI_URL}/qr_code?token=${CHATAPI_TOKEN}`
        await axios.get(url, {responseType: 'arraybuffer'}).then((r) => {
          console.log(r.data)
          if(r.status === 200){

            // this.button.qr.disabled = false
            this.button.qr.status = 'QR obtenido'

            let blob = new Blob(
              [r.data],
              {type: r.headers['content-type']}
            )

            this.qr.image = URL.createObjectURL(blob)
          }
        }).catch((e) => {

          console.error(e)
          this.button.qr.disabled = false
          this.button.qr.status = 'error al obtener QR'

        })
      },
      async getQueues(){

        const url = `${CHATAPI_URL}/showMessagesQueue?token=${CHATAPI_TOKEN}`
        const params = {}
        await axios.get(url, params).then((r) => {
          if(r.status === 200){


            this.queues.total = r.data.totalMessages
            this.queues.data = r.data.first100

          }
          console.log(r.data)
        }).catch((e) => {

          console.error(e)

        })
      },
      */
    },
  })
</script>

<style>
    body { padding: 2em; }


    /* Shared */
    .loginBtn {
        box-sizing: border-box;
        position: relative;
        /* width: 13em;  - apply for fixed size */
        margin: 0.2em;
        padding: 0 15px 0 46px;
        border: none;
        text-align: left;
        line-height: 34px;
        white-space: nowrap;
        border-radius: 0.2em;
        font-size: 16px;
        color: #FFF;
    }
    .loginBtn:before {
        content: "";
        box-sizing: border-box;
        position: absolute;
        top: 0;
        left: 0;
        width: 34px;
        height: 100%;
    }
    .loginBtn:focus {
        outline: none;
    }
    .loginBtn:active {
        box-shadow: inset 0 0 0 32px rgba(0,0,0,0.1);
    }


    /* Facebook */
    .loginBtn--facebook {
        background-color: #4C69BA;
        background-image: linear-gradient(#4C69BA, #3B55A0);
        /*font-family: "Helvetica neue", Helvetica Neue, Helvetica, Arial, sans-serif;*/
        text-shadow: 0 -1px 0 #354C8C;
    }
    .loginBtn--facebook:before {
        border-right: #364e92 1px solid;
        background: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/14082/icon_facebook.png') 6px 6px no-repeat;
    }
    .loginBtn--facebook:hover,
    .loginBtn--facebook:focus {
        background-color: #5B7BD5;
        background-image: linear-gradient(#5B7BD5, #4864B1);
    }


    /* Google */
    .loginBtn--google {
        /*font-family: "Roboto", Roboto, arial, sans-serif;*/
        background: #DD4B39;
    }
    .loginBtn--google:before {
        border-right: #BB3F30 1px solid;
        background: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/14082/icon_google.png') 6px 6px no-repeat;
    }
    .loginBtn--google:hover,
    .loginBtn--google:focus {
        background: #E74B37;
    }
</style>

</body>
</html>